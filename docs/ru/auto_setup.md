# Пошаговая инструкция по настройке автономного полета для Клевер 3/4

## Первоначальная настройка Raspberry Pi

- Установить Raspberry Pi и камеру на квадрокоптер по [инструкции](assemble_3.md) в разделе "Монтаж Raspberry".

- Скачать образ системы по [ссылке](microsd_images.md).

- Записать образ на MicroSD карту.
- Вставить карту в Raspberry Pi.
- Подключить питание к Raspberry Pi и ожидать появления Wi-Fi-сети. Для этого подключите Raspberry Pi к компьютеру через MicroUSB-кабель.

  На RPi должен периодически мигать зеленый светодиод. Он сигнализирует о нормальной работе операционной системы.

  > **Warning** Перед подключением Raspberry к компьютеру по USB необходимо вытащить из Raspberry провод питания (который идет от bec). Иначе могут быть проблемы с питанием.

- Подключиться к Wi-Fi и зайти в веб-интерфейс ([статья](wifi.md)).

  Во время первого включения сеть появляется не сразу. Нужно дождаться полной загрузки системы. Если в списке сетей долго не появляется сети Клевера, закройте окно с выбором сети и откройте снова. Тогда список сетей обновится.

> **Hint** Если на этом шаге вы подключились к интернету коптера, рекомендуем открыть [локальную версию этой статьи](http://192.168.11.1/docs/ru/auto_setup.html), иначе ссылки не будут работать.

- Подключиться к Raspberry Pi по SSH.

  Рекомендуем использовать веб-доступ. Для этого следуйте инструкциям в соответствующем разделе [статьи](ssh.md):

- Если необходимо, можно поменять название и пароль сети. Раздел [статьи](network.md) «Изменение пароля или SSID (имени сети)».

  Перемещать курсор можно только стрелками на клавиатуре.

> **Hint** Чтобы сохранить файл с настройками сети, необходимо последовательно нажать комбинации клавиш: `Ctrl+X` (выйти из редактирования файла), `Y` (подтвердить сохранение изменений), `Enter` (сохранить файл с текущим названием).

- Перезагрузить Raspberry Pi. Для этого нужно ввести команду:

  ```
  sudo reboot
  ```

  Соединение временно закроется, создастся новая сеть. К ней надо подключиться заново.

- Убедиться в корректной работе камеры. 

  В браузере зайти на адрес http://192.168.11.1:8080 и выбрать `Image_raw`.

  Более подробно можно прочитать в [статье](web_video_server.md) в разделе «Просмотр»:

  Если изображение размыто, необходимо сфокусировать линзу. Для этого покрутите объектив в одну или в другую сторону. Продолжайте крутить, пока резкость не станет максимальной.

  > **Hint** На камере должен гореть красный светодиод: он означает, что камера в данный момент производит съемку. Если светодиод не горит: либо камера подключена неправильно, либо операционная система не загрузилась, либо в настройках допущена ошибка.

## Настройка параметров Raspberry Pi для автономного полета

- Базовые команды для работы в команрдной строке Linux:

Показать список файлов:

```
ls
```

Перейти в папку с прописанием пути к ней:

```
cd catkin_ws/src/clever/clever/launch/
```

Открыть файл file.py:

```
nano file.py
```

Открыть файл clever.launch с прописанием полного пути к нему (сработает, если вы находитесь в другой папке):

```
nano ~/catkin_ws/src/clever/clever/launch/clever.launch
```

Сохранить файл (нажимать последовательно):

```
Ctrl+X; Y; Enter
```

Удалить файл или папку с названием name (ВНИМАНИЕ: операция выполнится без подтверждения. Будьте осторожны!):

```
rm -rf name
```

Создать папку с названием myfolder:

```
mkdir myfolder
```

Полная перезагрузка Raspberry Pi:

```
sudo reboot
```

Перезапук только систем Клевера:

```
sudo systemctl restart clever
```

Выполнить самопроверку Клевера:

```
rosrun clever selfcheck.py
```

Остановить программу

```
Ctrl+C
```

Запустить программу myprogram.py на Питоне:

```
python myprogram.py
```

Журнал событий процессов Клевера. Пролистывать список можно нажатием Enter или сочетанием клавиш Ctrl+V (пролистывает быстрее):

```
journalctl -u clever
```

Открыть файл sudoers от имени администратора (он не откроется без прописания sudo. Через sudo можно запускать другие команды, если они не открываются без прав администратора):

```
sudo nano /etc/sudoers
```

Большинство параметров, необходимых для полета, хранится в папке:

```
~/catkin_ws/src/clever/clever/launch/
```

- Зайти в папку:

```
cd ~/catkin_ws/src/clever/clever/launch/
```

  Символ `~` обозначает домашнюю директорию вашего пользователя. Если вы уже находитесь в ней, можно обойтись командой:
`cd catkin_ws/src/clever/clever/launch/`

> **Hint** Клавишей Tab можно автоматически дополнить названия файлов, папок или команд. Нужно начать вводить желаемое название и нажать Tab. Если не будет конфликтов, название напишется полностью. Например, чтобы быстро ввести путь к папке с настройками, после ввода ‘cd ‘ можно начать вводить следующую комбинацию клавиш: `c-Tab-s-Tab-c-Tab-c-Tab-l-Tab`. Таким образом можно сэкономить много времени при написании длинной команды, а также избежать возможных ошибок в написании пути.

  В этой папке необходимо отредактировать несколько файлов:
  
```
clever.launch 
aruco.launch 
main_camera.launch.
```

- Открыть файл `clever.launch `:

  ```
  nano clever.launch`
  ```
  
  Вы должны находиться в папке, в которой располагается файл. Если вы находитесь в другой папке, файл можно открыть, прописав путь к нему: 
  
  ```
  nano ~/catkin_ws/src/clever/clever/launch/clever.launch
  ```
  
  Если файл одновременно редактируют два пользователя, а также если в прошлый раз закрытие файла произошло некорректно, программа nano не отобразит файл сразу, а попросит дополнительное разрешение. Для этого нужно нажать клавишу Y.

  Если содержимое файла все равно пусто, возможно, вы неверно ввели имя файла. Нужно обращать внимание на расширение и вписывать его полностью. Если вы вписали неверное имя или расширение, программа nano создаст пустой файл с этим названием, что нежелательно.

- В файле clever.launch найти строчку:

  ```
  <arg name="aruco" default="false"/>
  ```
  
и заменить `false` на `true`:

  ```
  <arg name="aruco" default="true"/>.
  ```
  Это активирует модуль распознавания aruco-маркеров.

> **Hint** Перемещать курсор можно только стрелками на клавиатуре.

- В файле `aruco.launch` нужно активировать несколько параметров. Подробнее в [статье](aruco_map.md).

  Должно получиться:
  
  ```
  <arg name="aruco_detect" default="true"/>
  <arg name="aruco_map" default="true"/>
  <arg name="aruco_vpe" default="true"/>`
  ```

- Сгенерировать поле с метками. Подробности в [статье](aruco_map.md) в разделе «Настройка карты маркеров».

  Пример команды для генерации поля, где:
  - длина маркера = 0.335 м (length)
  - 10 столбцов (x)
  - 10 строк (y)
  - расстояние между центрами меток по оси x = 1 м(dist_x)
  - расстояние между центрами меток по оси y = 1 м(dist_y)
  - номер первого маркера = 0 (first)
  - название карты остается стандартным: map.txt
  - нумерация идет с верхнего левого угла (ключ --top-left)

  ```
  rosrun aruco_pose genmap.py 0.335 10 10 1 1 0 > ~/catkin_ws/src/clever/aruco_pose/map/map.txt --top-left
  ```

  В большинстве полей нумерация начинается с нулевой метки. Также в большинстве случаев нумерация начинается с верхнего левого угла, поэтому при генерации очень важно указывать ключ --top-left

  > **Hint** Если вы зададите другое имя для файла с картой, его нужно прописать в файле `aruco.launch`. Найдите строку
`<param name="map" value="$(find aruco_pose)/map/map.txt"/>`
и замените название map.txt на название вашего файла.

- Отредактировать файл main_camera.launch для настройки камеры:

  Подробнее в [статье](camera_frame.md).

  В этом файле необходимо отредактировать строку с параметрами расположения камеры. Строка выглядит так:

  ```
  <node pkg="tf2_ros" type="static_transform_publisher" name="main_camera_frame" args="0.05 0 -0.07 -1.5707963 0 3.1415926 base_link main_camera_optical"/>
  ```

  В файле вы найдете много строк, похожих на эту, но большинство из них закомментированы (то есть не читаются) и только одна раскомментирована. Это заранее заготовленные настройки, из которых можно выбрать нужную вам.

  Комментарий в языке XML — это символы <!-- в начале строки и --> в конце строки. Пример закомментированной строки:
  
  ```
  <!--<node pkg="tf2_ros" type="static_transform_publisher" name="main_camera_frame" args="0.05 0 -0.07 -1.5707963 0 3.1415926 base_link main_camera_optical"/>-->
  ```
  
  Пример незакомментированной строки (строка будет учитываться программой):
  
  ```
  <node pkg="tf2_ros" type="static_transform_publisher" name="main_camera_frame" args="0.05 0 -0.07 -1.5707963 0 3.1415926 base_link main_camera_optical"/>
  ```
  Над этими строками написано, какому расоложению камеры соответствует настрйока. Если шлейф от камеры выходит вперед относительно коптера, нужно выбрать настройку:
  
  ```
  <!-- camera is oriented downward, camera cable goes forward  [option 2] -->
  ```
  
  Чтобы выбрать нужную настройку, необходимо раскомментировать соответствующую строку, а все остальные закомментировать.

- Сохранить изменения. Последовательно нажмите:

  ```
  Ctrl+x; Y; Enter
  ```

- Перезагрузить модуль клевер:

  ```
  sudo systemctl restart clever
  ```

## Настройка полетного контроллера для автономного полета

- Перепрошить полетный контроллер модифицированной прошивкой. Скачать её можно здесь:
https://clever.copterexpress.com/ru/firmware.html

- Инструкция по прошивке и настройке полетного контроллера — в статье ниже в разделе «Обновление прошивки Pixhawk». Следующий раздел выполнять не нужно, если коптер уже был откалиброван.

> **Warn** Обязательно выберете скачанную прошивку во время нажатия firmware.

  https://clever.copterexpress.com/ru/setup.html

## Соединение полетного контроллера и Raspberry Pi

- Соединить Raspberry Pi и Pixracer через MicroUSB-кабель. Кабель должен быть аккуратно плотно закручен и пропущен снизу коптера, чтобы не попасть в пропеллеры.

- Подключиться к полётному контроллеру через QGroundControl удаленно.
На образе настраивать ничего не надо, нужно лишь создать новое подключение в QGroundControl, выбрать его и подключиться. Настраивается оно, как на картинке в статье в разделе "TCP-бридж":
https://clever.copterexpress.com/ru/gcs_bridge.html

  Можно пока не подключать аккумулятор, а подать питание только на Raspberry Pi.

## Настройка пульта

- Настройка описана в статье в разделе «Настройка режимных каналов»:
https://clever.copterexpress.com/ru/setup.html

  Канал 5 должен располагаться на переключателе SwC; Канал 6 - на SwA. Однако вы можете настроить эти каналы любым удобным для вас образом.
  
## Выполнение автоматической проверки

Проверку следует выполнить, когда вы полностью настроили дрон. Подробно процедура описана в статье: https://clever.copterexpress.com/ru/selfcheck.html

- Выполнить команду:

  ```
  rosrun clever selfcheck.py
  ```

## Написание программы

- Открыть статью 
https://clever.copterexpress.com/ru/simple_offboard.html

- Скопировать из раздела "Использование из языка Python" пример кода и вставить в редактор (например, в Visual Studio Code, PyCharm, Sublime Text, Notepad++).

- Сохранить документ с расширением .py для включения подсветки текста.

- Далее необходимо добавить полётные команды в программу. Примеры таких команд представлены в статье. Нужно написать функции для взлета и полета в точку, а также для посадки.

- Взлет.

  Для взлета можно использовать функцию navigate. Пример команды для взлета:
  
  ```python
  navigate(x=0, y=0, z=1.5, speed=0.5, frame_id='body', auto_arm=True)
  ```
  
  Добавьте эту строку внизу программы.

  Также добавьте команду ожидания:
  
  ```python
  rospy.sleep(3)
  ```
  
> **Hint** Важно выделить время на выполнение команды navigate, иначе коптер, не дожидаясь выполнения предыдущей команды, сразу перейдет к выполнению следующей. Для этого используется команда rospy.sleep(). В скобках указывается время в секундах. Функция rosy.sleep() относится к предыдущей команде navigate, а не к последующей, то есть это время, которое мы даем на то, чтобы долететь до точки, обозначенной в предыдущем navigate.

- Зафиксировать положение дрона в системе координат маркерного поля.
  Для этого нужно выполнить navigate и указать в нем необходимые координаты (например, x=1, y=1, z=1.5) и выбрать систему координат (frame_id):
  

  ```python
  navigate(x=1, y=1, z=1.5, speed=1, frame_id='aruco_map')
  ```
  
- В итоге должно получиться:

  ```python
  navigate(x=0, y=0, z=1.5, speed=0.5, frame_id='body', auto_arm=True)
  rospy.sleep(3)
  navigate(x=1, y=1, z=1.5, speed=1, frame_id='aruco_map')
  ```
  
> **Warn** Обратите внимание, что параметр auto_arm=True ставится только при первом взлете. В остальных случаях его выставлять нельзя, иначе возникнут проблемы с перехватом управления.

- Если вы хотите добавить другие точки для пролета, нужно дописать еще один navigate и rospy.sleep(). Время нужно вычислить отдельно для каждой точки в зависимости от скорости пролета и расстояния между точками.
Например, если мы хотим полететь в точку (3,3,1.5):

  ```python
  navigate(x=3, y=3, z=1.5, speed=1, frame_id=‘aruco_map’)
  rospy.sleep(3)
  ```
  
> **Warn** Координаты не должны выходить за пределы вашего поля. Если поле имеет размер 4х4 метра, максимальное значение координат, которое стоит указывать, — 4.

- После пролета по точкам нужно приземлиться. Строка ставится в конце:

  ```
  land()
  ```

## Запись программы на дрон

Самый простой способ - это скопировать текст программы, создать новый файл в командной строке Клевера и вставить текст программы в файл.

- Для создания файла myprogram.py введите команду:

  ```
  nano myprogram.py
  ```
  
  Название можно выбрать любое, однако не рекомендуется использовать пробелы и специальные символы. Также расширение у программы всегда должно быть `.py`.
  
- Вставить текст в поле ввода. Если вы пользуетесь Веб-доступом Butterfly на Windows или Linux:

  ```
  Ctrl+Shift+V
  ```
  
  На Mac нажмите `Cmd+V`.
  
- Сохранить файл:

  ```
  Ctrl+x; Y; Enter
  ```
  
## Запуск программы

Необходимо тщательно подготовить дрон, пульт и программу.
  
